<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>База почтовых индексов</title>
		<meta charset="windows-1251" />
		<script>
			// Реализации IndexedDB все еще используют префиксы в именах
			var indexedDB = window.indexedDB || // Использовать стандартный API БД
				window.mozIndexedDB || // Или раннюю версию в Firefox
				window.webkitIndexedDB; // Или раннюю версию в Chrome
			// В Firefox не используются префиксы для следующих двух объектов:
			var IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction;
			var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange;
			
			// Эта функция будет использоваться для вывода сообщений об ошибках
			function logerr(e) {
				console.log("Ошибка IndexedDB " + e.code + ": " + e.message);
			}

			// Эта функция асинхронно получает объект базы данных (при необходимости
			// создает и инициализирует базу данных) и передает его функции f().
			function withDB(f) {
				var request = indexedDB.open("zipcodes"); // Открыть базу данных zipcode
				request.onerror = logerr; // Вывести сообщения об ошибках
				request.onsuccess = function() { // Или вызвать эту функцию по завершении
					var db = request.result; // Результатом запроса является база данных
					// Базу данных можно открыть всегда, даже если она не существует.
					// Мы проверяем версию, чтобы узнать, была ли БД создана и инициализирована.
					// Если  нет - это необходимо сделать. Но если БД уже настроена,
					// остается просто передать ее функции f().
					if (db.version === "1") f(db); // Если БД существует, передать её f()
					else initdb(db,f); // Иначе сначала инициализировать её
				}
			}
			
			// Принимает почтовый индекс, отыскивает город, которому он принадлежит,
			// и асинхронно передает название города указанной функции.
			function lookupCity(zip, callback) {
				withDB(function(db) {
					// Создать объект транзакции для этого запроса
					var transaction = db.transaction(["zipcodes"], // Требуемое хранилище
										IDBTransaction.READ_ONLY, // Не обновлять
										0); // Время ожидания не ограничено
					// Получить хранилище объектов из транзакции
					var objects = transaction.objectStore("zipcodes");
					// Запросить объект, соответствующий указанному индексу.
					// Строки выше выполнялись синхронно, но эта выполняется асинхронно
					var request = objects.get(zip);
					request.onerror = logerr; // Выводить сообщения об ошибках
					request.onsuccess = function() { // Передать результаты этой функции
						// Искомый объект сейчас в свойстве request.result
						var object = request.result;
						if (object) // Если соответствие найдено, передать город и штат функции
							callback(object.city + ", " + object.state);
						else // Иначе сообщить о неудаче
							callback("Неизвестный индекс");
					}
				});
			}
			
			// По указанному названию города отыскивает все почтовые индексы для всех
			// городов (в любом штате) с этим названием (с учетом регистра символов).
			// Асинхронно передает результаты по одному указанной функции
			function lookupZipcodes(city, callback) {
				withDB(function(db) {
					// Как и выше, создаём транзакцию и получаем хранилище объектов
					var transaction = db.transaction(["zipcodes"], IDBTransaction.READ_ONLY, 0);
					var store = transaction.objectStore("zipcodes");
					// На этот раз нам требуется получить индекс по названиям городов
					var index = store.index("cities");
					// Этот запрос может вернуть несколько результатов, поэтому, чтобы
					// получить их все, следует использовать объект курсора. Чтобы создать
					// курсор, нужно создать объект диапазона, представляющий диапазон ключей
					var range = new IDBKeyRange.only(city); // Диапазон с одним ключом			
					// Все, что выше, выполняется синхронно.
					// Теперь нужно запросить курсор, который возвращается асинхронно.
					var request = index.openCursor(range); // Запросить курсор
					request.onerror = logerr; // Сообщать об ошибках
					request.onsuccess = function() { // Передать курсор этой функции
						// Этот обработчик событий будет вызван несколько раз, по одному
						// для каждой записи, соответствующей запросу, и ещё один раз
						// с пустым курсором, указывающим на окончание результатов.
						var cursor = request.result; // Курсор в свойстве request.result
						if (!cursor) return; // Нет курсора = нет результатов
						var object = cursor.value; // Получить совпавшую запись
						callback(object); // Передать ее указанной функции
						cursor.continue(); // Запросить следующую запись
					};
				});
			}
			
			// Эта функция используется обработчиком onchange в документе ниже.
			// Она выполняет запрос к БД и отображает результаты
			function displayCity(zip) {
				lookupCity(zip, function(s) { document.getElementById('city').value=s; });
			}
			
			// Это другая функция, используемая обработчиком onchange в документе ниже.
			// Она выполняет запрос к БД и отображает результаты
			function displayZipcodes(city) {
				var output = document.getElementById("zipcodes");
				output.innerHTML = "Найденные индексы:";
				lookupZipcodes(city, function(o) {
					var div = document.createElement("div");
					var text = o.zipcode + ": " + o.city + ", " + o.state;
					div.appendChild(document.createTextNode(text));
					output.appendChild(div);
				});
			}
			
			// Настраивает структуру базы данных и заполняет ее данными, затем передает базу данных
			// функции f(). Эта функция вызывается функцией withDB(), если база данных еще не была
			// инициализирована. Это самая хитрая часть программы, поэтому мы оставили её напоследок.
			function initdb(db, f) {
				// Загрузка информации о почтовых индексах и сохранение её в базе данных может
				// потребовать некоторого дополнительного времени при первом запуске этого
				// приложения. Поэтому необходимо вывести сообщение, извещающее о выполнении операции.
				var statusline = document.createElement("div");
				statusline.style.cssText =
					"position:fixed; left:0px; top:0px; width:100%;" +
					"color:white; background-color: black; font: bold 18pt sans-serif;" +
					"padding: 10px; ";
				document.body.appendChild(statusline);
				function status(msg) { statusline.innerHTML = msg.toString(); };
				
				status("Инициализация базы данных почтовых индексов");
				
				// Единственное место, где можно определить или изменить структуру
				// базы данных IndexedDB - обработчик onsucess запроса setVersion.
				var request = db.setVersion("1"); // Попробовать изменить версию БД
				request.onerror = status; // Вывести сообщение в случае ошибки
				request.onsuccess = function() { // Иначе вызвать эту функцию
					// База данных почтовых индексов включает единственное хранилище.
					// Оно хранит объекты следующего вида: {
					// zipcode: "02134", // Отправьте на телепередачу Zoom!1 :-)
					// city: "Allston",
					// state: "MA",
					// latitude: "42.355147",
					// longitude: "-71.13164"
					// }
					//
					// Свойство "zipcode" используется в качестве ключа базы данных
					// Кроме того, создается индекс по названию города
					// Создать хранилище объектов, указав имя хранилища и объект с параметрами,
					// включающий "путь к ключу", определяющий имя свойства-ключа для этого
					// хранилища. (Если опустить путь к ключу, IndexedDB определит свой
					// собственный уникальный целочисленный ключ.)
					var store = db.createObjectStore("zipcodes", // имя хранилища
													{ keyPath: "zipcode" });
													
					// Создать в хранилище объектов индекс по названию города.
					// Строка пути к ключу передается этому методу непосредственно,
					// как обязательный аргумент, а не как свойство объекта с параметрами.
					store.createIndex("cities", "city");
					
					// Теперь необходимо загрузить информацию о почтовых индексах, преобразовать
					// ее в объекты и сохранить эти объекты в созданном выше хранилище.
					//
					// Файл с исходными данными содержит строки следующего вида:
					//
					// 02130,Jamaica Plain,MA,42.309998,-71.11171
					// 02131,Roslindale,MA,42.284678,-71.13052
					// 02132,West Roxbury,MA,42.279432,-71.1598
					// 02133,Boston,MA,42.338947,-70.919635
					// 02134,Allston,MA,42.355147,-71.13164
					//
					// Как ни странно, но почтовая служба США не обеспечивает свободный доступ
					// к этой информации, поэтому мы будем использовать устаревшие данные переписи
					// с сайта: http://mappinghacks.com/2008/04/28/civicspace-zip-code-database/
					// Для загрузки данных используется объект XMLHttpRequest.
					// Но для обработки данных по мере поступления будут использованы
					// новые события onload и onprogress, определяемые спецификацией XHR2
					var xhr = new XMLHttpRequest(); // Объект XHR для загрузки данных
					xhr.open("GET", "zipcodes.csv"); // HTTP-запрос типа GET для этого URL
					xhr.send(); // Запустить немедленно
					xhr.onerror = status; // Отображать сообщения об ошибках			
					var lastChar = 0, numlines = 0; // Уже обработанный объем
					
					// Обрабатывает файл базы данных блоками, по мере загрузки
					xhr.onprogress = xhr.onload = function(e) { // Сразу два обработчика!
						// Обработать блок между lastChar и последним принятым символом
						// перевода строки. (Нам требуется отыскать последний символ
						// перевода строки, чтобы не обработать неполную запись)
						var lastNewline = xhr.responseText.lastIndexOf("\n");
						if (lastNewline > lastChar) {
							var chunk = xhr.responseText.substring(lastChar, lastNewline)
							lastChar = lastNewline + 1; // Откуда начинать в следующий раз
							
							// Разбить новый фрагмент на строки
							var lines = chunk.split("\n");
							numlines += lines.length;
							
							// Чтобы вставить информацию о почтовом индексе в базу данных, необходимо
							// получить объект транзакции. Все операции добавления объектов
							// в базу данных, выполняемые с использованием этого объекта,
							// будут автоматически подтверждаться после выхода из этой функции,
							// когда броузер вернется в цикл обработки событий.
							// Чтобы создать объект транзакции, следует определить,
							// какие хранилища объектов будут использоваться (у нас имеется всего
							// одно хранилище). Кроме того, требуется сообщить, что будет
							// выполняться не только чтение, но и запись в базу данных:
							var transaction = db.transaction(["zipcodes"], // хранилища
																IDBTransaction.READ_WRITE);
																
							// Получить ссылку на хранилище из объекта транзакции
							var store = transaction.objectStore("zipcodes");
							
							// Теперь обойти в цикле строки в файле с почтовыми индексами,
							// создать на их основе объекты и добавить их в хранилище.
							for(var i = 0; i < lines.length; i++) {
								var fields = lines[i].split(",");// Значения через запятую
								var record = { // Сохраняемый объект
									zipcode: fields[0], // Все свойства - строки
									city: fields[1],
									state: fields[2],
									latitude: fields[3],
									longitude: fields[4]
								};
								
								// Вся прелесть IndexedDB API в том, что хранилище
								// объектов *по-настоящему* просто использовать.
								// Следующая строка добавляет запись:
								store.put(record); // Или add(), чтобы избежать затирания
							}
							
							status("Инициализация базы данных, загружено записей: "
									+ numlines + ".");
						}
					
						if (e.type == "load") {
							// Если это было последнее событие load, значит, мы отправили в базу
							// данных все сведения о почтовых индексах. Но, так как мы только
							// что обработали порядка 40000 записей, они все еще могут записываться
							// в хранилище. Поэтому мы выполним простой запрос. Когда он будет
							// успешно выполнен, это послужит сигналом, что база данных готова
							// к работе, и наконец можно удалить строку сообщения и вызвать
							// функцию f(), которая так давно была передана функции
							withDB()
							lookupCity("02134", function(s) { // Allston, MA
								document.body.removeChild(statusline);
								withDB(f);
							});
						}
					}
				}
			}
		</script>
	</head>
	<body>
		<p>Введите почтовый индекс, чтобы отыскать город:</p>
		Индекс: <input onchange="displayCity(this.value)"></input>
		Город: <output id="city"></output>
		</div>
		<div>
		<p>Введите название города (с учетом регистра символов, без названия штата),
		чтобы отыскать все города с этим названием и их почтовые индексы:</p>
		Город: <input onchange="displayZipcodes(this.value)"></input>
		<div id="zipcodes"></div>
		</div>
		<p><i>Этот пример работает только в Firefox 4 и Chrome 11.</i></p>
		<p><i>Выполнение первого запроса может занять длительное время.</i></p>
		<p><i>Вам может потребоваться запустить Chrome с ключом --unlimited-quota-forindexeddb</i></p>
	</body>
</html>
